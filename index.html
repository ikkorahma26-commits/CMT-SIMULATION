<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">

<style>
body{margin:0;font-family:Segoe UI,Arial;background:#0f172a;color:#e5e7eb;overflow:auto}
.screen{width:100vw;height:100vh;display:flex;justify-content:center;align-items:center}
.hidden{display:none}

/* === LOGIN === */
#login{
  flex-direction:column;
  gap:18px;
  background:
    linear-gradient(rgba(2,6,23,.85),rgba(2,6,23,.85)),
    url('puninar.jpg') center/cover no-repeat;
}
#login input{
  padding:16px;
  border-radius:14px;
  border:none;
  width:380px;
  font-size:16px;
}
#login button{
  padding:16px 42px;
  border-radius:16px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
}

/* === LOBBY === */
#lobby{flex-direction:column}
#lobbyCards{display:flex;gap:20px;margin-top:20px}

/* === OPERATIONAL === */
.container{padding:20px;display:grid;grid-template-columns:360px 1fr;gap:20px;width:100%}
.alert-board,.panel{background:#020617;border:1px solid #1e293b;border-radius:18px;padding:18px}
.alert-board > div{margin-bottom:14px}

.alert-card{
border:1px solid #38bdf8;border-radius:16px;padding:14px;
box-shadow:0 0 12px rgba(56,189,248,.25);cursor:pointer;transition:.2s;width:300px
}
.alert-card.call{animation:shake .6s infinite}
@keyframes shake{
0%{transform:translateX(0)}
25%{transform:translateX(-3px)}
50%{transform:translateX(3px)}
75%{transform:translateX(-3px)}
100%{transform:translateX(0)}
}

.badge{float:right;font-size:11px;padding:4px 10px;border-radius:999px;background:#0284c7}

.panel{
position:relative;
max-height:90vh;
overflow-y:auto;
padding-bottom:40px;
}

.close-btn{
position:absolute;top:16px;right:16px;padding:8px 14px;border-radius:999px;
border:none;background:#22c55e;color:#022c22;font-weight:600;cursor:pointer
}

.section{border:1px dashed #334155;border-radius:14px;padding:12px;margin-top:14px}
.section.locked{opacity:.5}

.call-box{
border:1px dashed #38bdf8;border-radius:14px;padding:16px;margin:16px 0
}
.call-btn{
width:100%;padding:14px;border-radius:12px;border:none;font-weight:700;
background:linear-gradient(90deg,#0284c7,#38bdf8);color:#020617;cursor:pointer
}
.timer{
position:absolute;
top:16px;
right:180px;
font-weight:700;
}

.timer.red{
color:#ef4444;
}

.close-btn.closed{
background:#ef4444;
color:white;
}

.accordion-header{
display:flex;
justify-content:space-between;
cursor:pointer;
font-weight:600;
}

.accordion-content{
margin-top:10px;
display:none;
max-height:200px;
overflow-y:auto;
}

.checkbox-item{
display:flex;
align-items:center;
margin:6px 0;
gap:8px;
cursor:pointer;
}

.checkbox-item input{
width:18px;
height:18px;
}

html{
scroll-behavior:smooth;
}

.popup-call{
position:fixed;
top:20px;
right:20px;
background:#020617;
border:1px solid #38bdf8;
padding:16px 20px;
border-radius:14px;
box-shadow:0 0 15px rgba(56,189,248,.6);
display:flex;
align-items:center;
gap:12px;
animation:shake .6s infinite;
z-index:9999;
font-weight:600;
}

.popup-call .icon{
font-size:22px;
}

.issue-timer{
  font-size:12px;
  margin-top:6px;
  opacity:.85;
  font-weight:600;
}

</style>
</head>
<body>

<!-- LOGIN -->
<div class="screen" id="login">
  <h1 style="margin:0 0 8px 0;font-size:32px">CMT Skill Test Simulation</h1>
  <input placeholder="Nama Lengkap">
  <input placeholder="NPK">
  <button onclick="start()">Start Simulation</button>
</div>

<!-- LOBBY -->
<div class="screen hidden" id="lobby">
  <div id="lobbyCards"></div>
</div>

<!-- OPERATIONAL -->
<div class="screen hidden" id="operational">
  <div class="container">
    <div style="position:relative">
  <div id="globalTimer"
       style="position:absolute;top:-30px;left:0;font-weight:700">
       ‚è± 00:00
  </div>
  <div class="alert-board" id="board"></div>
</div>
    <div class="panel">
      <button class="close-btn" onclick="closeIssue()">Close Abnormality</button>
      <div class="timer" id="timer">00:00</div>
      <h3>Issue Detail</h3>
      <div id="story"></div>

      <div class="call-box" id="callBox">
        <div id="callStatus">üìû Incoming Call</div><br>
        <button class="call-btn" onclick="callDriver()">CALL DRIVER</button>
      </div>

      <div class="section locked" id="respon">Respon CMT üîí</div>
      <div class="section locked" id="eskalasi">Eskalasi üîí</div>
      <div class="section locked" id="follow">Follow Up üîí</div>
    </div>
  </div>
</div>

<script>
/* ===============================
   DATA JSON ASLI (A‚ÄìG)
================================ */
const rawData = [
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Out Of Sequence",
   "issue": "Unit B 9833 TXV melakukan delivery tidak sesuai sequence point dalam shipment sehingga alert Out Of Sequence muncul ",
   "respon": "Melakukan konfirmasi dengan driver terkait urutan pick/drop point yang akan dijalankan, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Planner Pool",
   "follow up respon": "Menginformasikan perubahan urutan pick/drop point ke planner pool, Set Unsequence TEMON, Close Abnormality",
   "unit": "Unit B 9833 TXV"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Out Of Sequence",
   "issue": "Unit B 9054 TEN yang merupakan unit vendor melakukan delivery tidak sesuai sequence point dalam shipment sehingga alert Out Of Sequence muncul ",
   "respon": "Melakukan konfirmasi dengan driver terkait urutan pick/drop point yang akan dijalankan, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Planner Pool & Vendor Management Staff",
   "follow up respon": "Menginformasikan perubahan urutan pick/drop point ke planner pool, Set Unsequence TEMON, Close Abnormality",
   "unit": "Unit B 9054 TEN"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Out Of Sequence",
   "issue": "Unit B 9833 TXV diplanningkan membawa 4 shipment hari ini, namun didapatkan bahwa keterangan shipment aktif tidak sesuai urutannya dengan sequence yang ada di TEMON",
   "respon": "Melakukan konfirmasi dengan driver terkait urutan shipment yang akan dijalankan, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Planner Pool",
   "follow up respon": "Menginformasikan perubahan urutan ke planner pool, Mengubah urutan shipment sesuai aktual jalan di TEMON, Mengubah Plan Start Delivery di TEMON, Close Abnormality",
   "unit": "Unit B 9833 TXV"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Out Of Sequence",
   "issue": "Unit 9054 TEN diplanningkan membawa 4 shipment hari ini, namun didapatkan bahwa keterangan shipment aktif tidak sesuai urutannya dengan sequence yang ada di TEMON",
   "respon": "Melakukan konfirmasi dengan driver terkait urutan shipment yang akan dijalankan, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Planner Pool & Vendor Management Staff",
   "follow up respon": "Menginformasikan perubahan urutan ke planner pool, Mengubah urutan shipment sesuai aktual jalan di TEMON, Mengubah Plan Start Delivery di TEMON, Close Abnormality",
   "unit": "Unit 9054 TEN"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "GPS OFF",
   "issue": "Unit Puninar, B 9140 IG,  yang membawa shipment dari tanjung priok port menuju area drop point customer terdeteksi alert GPS OFF\n",
   "respon": " Call driver, Instruksi menepi untuk driver, Rekam video kondisi segel",
   "branch condition": "Mesin Menyala",
   "eskalasi": "-",
   "follow up respon": "Mengarahkan driver untuk mematikan mesin, Close Abnormality",
   "unit": "Unit B 9140 IG"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "GPS OFF",
   "issue": "Unit B 9927 TEI yang sedang melakukan proses unloading di area drop point terakhir terdeteksi alert seperti berikut ",
   "respon": "Call driver",
   "branch condition": "Mesin Menyala",
   "eskalasi": "-",
   "follow up respon": "Mengarahkan driver untuk mematikan, Close Abnormality",
   "unit": "Unit B 9927 TEI"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "GPS OFF",
   "issue": "Unit B 9654 QZ yang telah selesai unloading di area customer",
   "respon": "Call driver",
   "branch condition": "Sedang Menunggu Uang Jalan untuk shipment selanjutnya",
   "eskalasi": "-",
   "follow up respon": "Mengarahkan driver untuk mematikan, Close Abnormality",
   "unit": "Unit B 9654 QZ"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Idle Time Excedeed",
   "issue": "Unit B 9032 TEJ berhenti diluar area dengan geofence melebihi standard waktu sehingga alert timbul",
   "respon": "Call driver, Rekam video kondisi segel, Eskalasi",
   "branch condition": "Segel OK, namun unit tidak melanjutkan perjalanan",
   "eskalasi": "CMT Head, Pool, GS",
   "follow up respon": "BNF tentang Driver, Close Abnormality",
   "unit": "Unit B 9032 TEJ"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Idle Time Excedeed",
   "issue": "Unit B 9093 TVU berhenti selama lebih dari 4 jam didalam check point/geofence, namun  area tersbeut bukan area pick atau drop point",
   "respon": "Call driver, Rekam video kondisi segel, Eskalasi",
   "branch condition": "Segel NG",
   "eskalasi": "CMT Head, Pool, GS",
   "follow up respon": "BNF Segel NG, Close Abnormality",
   "unit": "Unit B 9093 TVU"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Idle Time Excedeed",
   "issue": "Unit B 9005 UPV. yang  membawa muatan berhenti di area pick/drop point lebih dari 4 jam ",
   "respon": "Call driver, Rekam video kondisi segel, Eskalasi",
   "branch condition": "Segel NG",
   "eskalasi": "CMT Head, Pool, GS",
   "follow up respon": "BNF Segel NG, Close Abnormality",
   "unit": "Unit B 9005 UPV"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Idle Time Excedeed",
   "issue": "Unit B 9154 SXS yang tidak membawa muatan berhenti di area pick/drop point lebih dari 4 jam ",
   "respon": "Call driver, Rekam video kondisi segel",
   "branch condition": "-",
   "eskalasi": "-",
   "follow up respon": "Mengarahkan driver untuk jalan kembali sesuai rute standar",
   "unit": "Unit B 9154 SXS"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Driving Over 4 Hours ",
   "issue": "Diketahui bahwa driver Deni Sanjaya, melakukan delivery dari Karawang-TGPP (Short Haul)",
   "respon": "Call driver, Instruksi driver untuk menepi",
   "branch condition": "-",
   "eskalasi": "-",
   "follow up respon": "Close Abnormality",
   "unit": "Unit B 9253 TEI"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Driving Over 4 Hours ",
   "issue": "Diketahui bahwa driver Deni Sanjaya bersama Yoga Saputra, melakukan delivery dari Cikarang - Aceh (Long Haul)",
   "respon": "Call driver, Instruksi driver untuk menepi, Instruksi pergantian driver",
   "branch condition": "-",
   "eskalasi": "-",
   "follow up respon": "Close Abnormality",
   "unit": "Unit B 9253 TEI"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Harsh Acceleration",
   "issue": "Driver Rahmat Mutaqim terdeteksi melakukan violation berupa harsh acceleration",
   "respon": "Call driver, Instruksi driver untuk menepi, Investigasi violation kepada driver, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Driver Development & Driver Management",
   "follow up respon": "BNF Violation, Close Abnormality",
   "unit": "Unit B 9881 UOJ"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Harsh Breaking",
   "issue": "Pada pukul 10.20, Driver Mahbul Fatma Negara, melakukan violation Harsh Break sebanyak 2 kali",
   "respon": "Call driver, Instruksi driver untuk menepi, Investigasi violation kepada driver, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Driver Development & Driver Management",
   "follow up respon": "BNF Violation, Close Abnormality",
   "unit": "Unit B 9117 LUA"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Harsh Cornering",
   "issue": "Unit B 9774 TYY pada jam 8.15 terdeteksi melakukan harsh cornering sehingga menimbulkan alert abnormality",
   "respon": "Call driver, Instruksi driver untuk menepi, Investigasi violation kepada driver, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Driver Development & Driver Management",
   "follow up respon": "BNF Violation, Close Abnormality",
   "unit": "Unit B 9774 TYY"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Over Speeding",
   "issue": "Unit B 9491 TXV melaju kencang pada kecepatan 80 km/jam di tol cikampek",
   "respon": "Call driver, Instruksi driver untuk menepi, Investigasi violation kepada driver, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Driver Development & Driver Management",
   "follow up respon": "BNF Violation, Close Abnormality",
   "unit": "Unit B 9491 TXV"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Out of Route ",
   "issue": "Unit B 9045 TVU melakakukan delivery tidak sesuai dengan rute standar ",
   "respon": "Call driver, Instruksi menepi untuk driver, Rekam video kondisi segel, Eskalasi",
   "branch condition": "Segel NG",
   "eskalasi": "CMT Head, Pool, GS",
   "follow up respon": "BNF Segel NG, Close Abnormality",
   "unit": "Unit B 9045 TVU"
 },
 {
   "source": "Alert Abnormality TEMON",
   "type of abnormality": "Out of Route",
   "issue": "Unit B 9045 TVU melakakukan delivery tidak sesuai dengan rute standar ",
   "respon": "Call driver, Instruksi menepi untuk driver, Rekam video kondisi segel,  Eskalasi",
   "branch condition": "Segel OK, namun unit tidak melanjutkan perjalanan sesuai rute standar",
   "eskalasi": "CMT Head, Pool, GS",
   "follow up respon": "Validasi dengan GS, Memberikan arahan driver untuk kembali ke rute standar",
   "unit": "Unit B 9045 TVU"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "Shipment Cancel masih muncul di TEMON",
   "issue": "Planner sudah melakukan konfirmasi untuk Shipment SHBG120251219-0529 dengan nopol B 9627 TEI di cancel, namun di dashboard monitoring TEMON masih termuat",
   "respon": "Eskalasi",
   "branch condition": "-",
   "eskalasi": "Planner Pool",
   "follow up respon": "Force Closed Shipment",
   "unit": "Unit B 9627 TEI"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "Belum termuat Nopol / Shipment aktif tidak muncul di TEMON",
   "issue": "Shipment menggunakan unit vendor tidak memiliki Keterangan Nopol unit",
   "respon": "Eskalasi",
   "branch condition": "-",
   "eskalasi": "Vendor Management Staff",
   "follow up respon": "Konfirmasi Nopol yang digunakan, Mendaftarkan nopol unit di master TEMON",
   "unit": "-"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "GPS unit vendor tidak dapat diakses",
   "issue": "Unit vendor menggunakann GPS yang berbeda dengan existing provider Puninar",
   "respon": "Eskalasi",
   "branch condition": "-",
   "eskalasi": "CMT Staff, CMT Leader, CMT Head, dan Vendor Management Staff",
   "follow up respon": "Monitoring Manual setiap 20 menit",
   "unit": "-"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "Geocode tidak termuat dalam easy go (TMS)",
   "issue": "Pada saat ingin melakukan monitoring area pick point dari customer A, CMT Operator tidak dapat menemukan geocode yang termuat di TEMON",
   "respon": "Eskalasi",
   "branch condition": "-",
   "eskalasi": "CMT Staff, CMT Leader, Tim IT",
   "follow up respon": "Menghubungi IT untuk pemeriksaan data integrasi",
   "unit": "-"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "Wing/Backdoor terbuka diluar lokasi bongkar/muat (TMS)",
   "issue": "Muncul alert wing terbuka untuk unit  pandaan yang sedang jalan",
   "respon": "Call driver, Instruksi driver untuk menepi, Rekam Video, Eskalasi",
   "branch condition": "-",
   "eskalasi": "CMT Head, Pool, GS",
   "follow up respon": "BNF Wing terbuka",
   "unit": "-"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "GPS unit vendor oncall tidak dapat diakses",
   "issue": "Pada tanggal 29 Desember 2025, Unit B 9140 IG terdeteksi belum menggunakan PEVO Driver",
   "respon": "Eskalasi",
   "branch condition": "-",
   "eskalasi": "CMT Staff, CMT Leader, Vendor Mangement Staff",
   "follow up respon": "BNF Driver belum menggunakan PEVO",
   "unit": "Unit B 9140 IG"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "Driver Sakit",
   "issue": "Driver Subhan melakukan panggilan kepada operator CMT, dari hasil percakapan tersebut driver subhan mengkonfirmasi keadaanya sedang tidak sehat dan tidak memiliki pengganti driver",
   "respon": "Eskalasi",
   "branch condition": "-",
   "eskalasi": "Pool Head, GS",
   "follow up respon": "Memastikan kondisi driver dan muatan aman, Menghubungi pool head dan GS",
   "unit": "-"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "Unit Ditilang",
   "issue": "Driver Selamet Hamzah mengkonfirmasi bahwa unit B 9005 UPV, terkena tilang di jalan tol bandung",
   "respon": "Eskalasi",
   "branch condition": "-",
   "eskalasi": "Pool Head, GS",
   "follow up respon": "Membuat BNF, Mengarahkan driver untuk mengirimkan bukti tilang",
   "unit": "Unit B 9005 UPV"
 },
 {
   "source": "Konfirmasi Driver",
   "type of abnormality": "Storing",
   "issue": "Unit B 9590 TRU yang sedang loading di area supplier tidak bisa di starter ",
   "respon": "Call driver, Instruksi driver untuk menepi, Rekam Video, Eskalasi",
   "branch condition": "-",
   "eskalasi": "Pool Head, WS",
   "follow up respon": "Meneruskan informasi request permintaan storing unit ke pool head dan WS",
   "unit": "Unit B 9590 TRU"
 }
];

/* ===============================
   GLOBAL
================================ */
let issues = [];
let current = 0;
let called = {};

let participantName = "";
let participantNPK = "";
let allResults = JSON.parse(localStorage.getItem("CMT_RESULTS")) || [];

let sectionStartTime = {};
let sectionTimes = {};
let issueIntervals = {};
let simulationStart = null;
let globalInterval = null;
let issueWindows = {};
let responseTracking = {};
let issueTimers = {};
let activeIssueIndex = null;

setInterval(() => {

  Object.keys(issueTimers).forEach(index => {

    const data = issueTimers[index];
    if(data.closed) return;

    const diff = Math.floor((Date.now() - data.start) / 1000);
    data.duration = diff;

  });

  if(activeIssueIndex !== null){
    const active = issueTimers[activeIssueIndex];
    if(active){

      const m = String(Math.floor(active.duration/60)).padStart(2,"0");
      const s = String(active.duration%60).padStart(2,"0");

      const timerEl = document.getElementById("timer");
      if(timerEl){
        timerEl.innerText = m + ":" + s;
      }
    }
  }

},1000);


/* ===============================
   UTILITIES
================================ */
function shuffle(arr){
  return [...arr].sort(() => 0.5 - Math.random());
}
function randomUnit(){
  const L="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const r=()=>Math.floor(Math.random()*10);
  const l=()=>L[Math.floor(Math.random()*26)];
  return `B ${r()}${r()}${r()}${r()} ${l()}${l()}${l()}`;
}
function buildDetail(issue, branch){
  if(branch === "-" || !branch){
    return `<div style="margin-top:10px">${issue}</div>`;
  }
  return `
    <div style="margin-top:10px">${issue}</div>
    <div style="
      margin-top:8px;
      padding:6px 10px;
      border-left:3px solid #38bdf8;
      opacity:.9;
      font-size:14px;">
      ‚ÑπÔ∏è ${branch}
    </div>
  `;
}
function getChecked(sectionId){
  return [...document.querySelectorAll(`#${sectionId} input:checked`)]
    .map(cb => cb.value);
}
function restoreAnswers(sectionId, values){
  const checkboxes = document.querySelectorAll(`#${sectionId} input`);
  checkboxes.forEach(cb=>{
    if(values.includes(cb.value)){
      cb.checked = true;
    }
  });
}

/* ===============================
   TYPEWRITER EFFECT
================================ */
function typeWriterEffect(element, html, speed = 20){

  element.innerHTML = "";

  const temp = document.createElement("div");
  temp.innerHTML = html;

  const blocks = Array.from(temp.children);

  let blockIndex = 0;

  function typeNextBlock(){

    if(blockIndex >= blocks.length) return;

    const originalBlock = blocks[blockIndex];

    const newBlock = originalBlock.cloneNode(false);
    element.appendChild(newBlock);

    const text = originalBlock.textContent; // <-- GANTI pakai textContent
    let charIndex = 0;

    function typeChar(){
      if(charIndex < text.length){
        newBlock.textContent += text[charIndex]; // <-- pakai textContent
        charIndex++;
        setTimeout(typeChar, speed);
      } else {
        blockIndex++;
        setTimeout(typeNextBlock, 200);
      }
    }

    typeChar();
  }

  typeNextBlock();
}

/* ===============================
   GENERATE SOAL
   (2 TEMON + 1 INCOMING CALL)
================================ */
function generateIssues(){
  const temon = shuffle(
    rawData.filter(d => d["source"] === "Alert Abnormality TEMON")
  ).slice(0,2);

  const call = shuffle(
    rawData.filter(d => d["source"] === "Konfirmasi Driver")
  ).slice(0,1);

  delayedCallIssue = call[0];

  issues = temon.map(row => ({
    type: row["type of abnormality"],            // TYPE OF ABNORMALITY
    source: row["source"],          // SOURCE
    issueText: row["issue"], 
    branch:row["branch condition"], // BRANCH CONDITION
    unit: row["unit"],           // UNIT
  }));
}

function triggerDelayedCall(){

  const popup = document.createElement("div");
  popup.className = "popup-call";
  popup.innerHTML = `
    <div class="icon">üìû</div>
    <div>Incoming Call</div>
  `;

  document.body.appendChild(popup);

  // Popup tampil 10 detik
  setTimeout(()=>{
    popup.remove();

    // Masukkan Konfirmasi Driver ke list issue
issues.push({
  type: delayedCallIssue["type of abnormality"],
  source: delayedCallIssue["source"],
  issueText: delayedCallIssue["issue"],
  branch: delayedCallIssue["branch condition"],
  unit: delayedCallIssue["unit"],
});

    renderBoard();

  },10000);
}

/* ===============================
   FLOW (UI TIDAK DIUBAH)
================================ */
function start(){
  const inputs = document.querySelectorAll("#login input");
  participantName = inputs[0].value;
  participantNPK = inputs[1].value;

  /* ADMIN LOGIN */
  if(participantName === "CMT" && participantNPK === "cmt123"){
    showAdminDashboard();
    return;
  }
  generateIssues();
  document.getElementById("login").classList.add("hidden");
  document.getElementById("lobby").classList.remove("hidden");
  lockAll();
  renderLobby();
  startTimer();

// Trigger incoming call 1 menit setelah start
setTimeout(()=>{
  triggerDelayedCall();
},60000);
}

function renderLobby(){
  const c=document.getElementById("lobbyCards");
  c.innerHTML="";
  issues.forEach((i,idx)=>{
    const d=document.createElement("div");
    d.className="alert-card"+(i.source==="Konfirmasi Driver"?" call":"");
    if(i.source==="Konfirmasi Driver"){
      d.innerHTML=`<span class="badge">Active</span><b>üìû Incoming Call</b>`;
    } else {
      d.innerHTML=`<span class="badge">Active</span>
      <b>‚ö†Ô∏è TEMON Alert</b><br>${i.type}<br><small>Unit: ${i.unit}</small>`;
    }
    d.onclick=()=>openOperational(idx);
    c.appendChild(d);
  });
}

function openOperational(i){
  current=i;
  document.getElementById("lobby").classList.add("hidden");
  document.getElementById("operational").classList.remove("hidden");
  renderBoard();
  openIssue(i);
}

function renderBoard(){
  const b=document.getElementById("board");
  b.innerHTML="";
  issues.forEach((i,idx)=>{
    const d=document.createElement("div");
    d.className="alert-card"+(i.source==="Konfirmasi Driver"?" call":"");
    if(i.source==="Konfirmasi Driver"){
      d.innerHTML=`<span class="badge">Active</span><b>üìû Incoming Call</b>`;
    } else {
      d.innerHTML=`<span class="badge">Active</span>
      <b>‚ö†Ô∏è TEMON Alert</b><br>${i.type}<br><small>Unit: ${i.unit}</small>`;
    }
    d.onclick=()=>openIssue(idx);
    b.appendChild(d);
  });
}
function updateIssueCardTimer(index){

  const cards = document.querySelectorAll(".alert-card");
  const card = cards[index];
  if(!card) return;

  let timerEl = card.querySelector(".issue-timer");

  if(!timerEl){
    timerEl = document.createElement("div");
    timerEl.className = "issue-timer";
    card.appendChild(timerEl);
  }

  const t = issueTimers[index]?.duration || 0;
  const m = String(Math.floor(t/60)).padStart(2,"0");
  const s = String(t%60).padStart(2,"0");

  timerEl.innerText = "‚è± " + m + ":" + s;
}

function stopShake(index){
  const cards=document.querySelectorAll(".alert-card");
  if(cards[index]) cards[index].classList.remove("call");
}

function openIssue(i){
  // üî• SIMPAN JAWABAN ISSUE SEBELUMNYA
  if(current !== undefined && issueData[current]){
    userAnswers[current] = {
      respon: getChecked("respon"),
      eskalasi: getChecked("eskalasi"),
      follow: getChecked("follow")
    };
  }

  // baru pindah issue
  current = i;
  activeIssueIndex = i;
  const issue = issues[i];
const closeBtn = document.querySelector(".close-btn");

if(completedIssues[i]){
  closeBtn.classList.add("closed");

  // Lock checkbox kalau sudah pernah di close
  document.querySelectorAll("#respon input, #eskalasi input, #follow input")
    .forEach(cb => cb.disabled = true);

} else {
  closeBtn.classList.remove("closed");

  // Aktifkan checkbox kalau belum close
  document.querySelectorAll("#respon input, #eskalasi input, #follow input")
    .forEach(cb => cb.disabled = false);
}

  // kalau timer belum ada ‚Üí buat
  if(!issueTimers[i]){
    issueTimers[i] = {
      start: Date.now(),
      duration: 0,
      closed: false
    };
  }

  // tampilkan timer sesuai issue ini
  if(issueTimers[i].closed){
    document.getElementById("timer").innerText =
      formatMMSS(issueTimers[i].duration);
  } else {
    const diff = Math.floor(
      (Date.now() - issueTimers[i].start)/1000
    );
    document.getElementById("timer").innerText =
      formatMMSS(diff);
  }


document.getElementById("story").innerHTML = `
  <div style="font-weight:600;margin-bottom:6px">
    ${issue.type} ‚Äì ${issue.unit}
  </div>
`;


  unlock();
  const callStatus=document.getElementById("callStatus");
if(callStatus){
  if(called[i]){
    callStatus.innerHTML = "üìû " + issue.issueText;
    unlock();
  } else {
    callStatus.innerText = "üìû Incoming Call";
    lockAll();
  }
}

if(issue.source === "Konfirmasi Driver"){

  document.getElementById("callBox").innerHTML = `
    <button class="call-btn" onclick="acceptCall()">YES</button>
    <button class="call-btn" 
      style="margin-top:10px;background:#ef4444;color:white"
      onclick="rejectCall()">NO</button>
  `;

}else{

  document.getElementById("callBox").innerHTML = `
    <div id="callStatus">üìû Incoming Call</div><br>
    <button class="call-btn" onclick="callDriver()">CALL DRIVER</button>
  `;
}
const row = rawData.find(r =>
  r["type of abnormality"] === issues[i].type
);

if(row){
  const correctRespon = splitAnswer(row["respon"]);
  const correctEskalasi = splitAnswer(row["eskalasi"]);
  const correctFollow = splitAnswer(row["follow up respon"]);

  issueData[i] = {
    respon: correctRespon,
    eskalasi: correctEskalasi,
    follow: correctFollow
  };
if(!completedIssues[i]){
  buildCheckbox("respon", correctRespon);
  buildCheckbox("eskalasi", correctEskalasi);
  buildCheckbox("follow", correctFollow);
  // üî• RESTORE JAWABAN LAMA
}
  if(userAnswers[i]){
    restoreAnswers("respon", userAnswers[i].respon);
    restoreAnswers("eskalasi", userAnswers[i].eskalasi);
    restoreAnswers("follow", userAnswers[i].follow);
 }
}

  stopShake(i);
}

function callDriver(){
  called[current] = true;

  const issue = issues[current];
  const box = document.getElementById("callBox");

box.innerHTML = `
  <div style="display:flex;align-items:flex-start;gap:10px">
    <div style="font-size:18px;margin-top:4px">üìû</div>
    <div id="callStatus" style="flex:1"></div>
  </div>
`;

  typeWriterEffect(
    document.getElementById("callStatus"),
    buildDetail(issue.issueText, issue.branch),
    15
  );
  unlock();
}
function acceptCall(){

  called[current] = true;

  const issue = issues[current];
  const box = document.getElementById("callBox");

box.innerHTML = `
  <div style="display:flex;align-items:flex-start;gap:10px">
    <div style="font-size:18px;margin-top:4px">üìû</div>
    <div id="callStatus" style="flex:1"></div>
  </div>
`;

  typeWriterEffect(
    document.getElementById("callStatus"),
    buildDetail(issue.issueText, issue.branch),
    15
  );

  unlock();
}

function rejectCall(){
  alert("Call Rejected");
}
function lockAll(){
 ["respon","eskalasi","follow"].forEach(id=>{
  document.getElementById(id).classList.add("locked");
 });
}
function unlock(){
 ["respon","eskalasi","follow"].forEach(id=>{
  document.getElementById(id).classList.remove("locked");
 });
}
function closeIssue(){ lockAll(); }

/* ===============================
   EXTENDED ENGINE
================================ */

let timerInterval = null;
let startTime = null;
let issueData = {};
let completedIssues = {};
let scores = [];
let userAnswers = {};


/* ===== SPLIT JAWABAN ===== */
function splitAnswer(str){
 if(!str || str.trim()==="-") return ["Tidak diperlukan eskalasi"];

 return str
  .replace(/ dan /gi,",")
  .replace(/ & /gi,",")
  .replace(/;/g,",")
  .split(",")
  .map(s=>s.trim())
  .filter(s=>s.length>0);
}

/* ===== BUILD CHECKBOX ===== */
function buildCheckbox(sectionId, correctAnswers){

 const section = document.getElementById(sectionId);
 section.innerHTML = `
  <div class="accordion-header">
    ${sectionId.toUpperCase()}
    <span>‚ñº</span>
  </div>
  <div class="accordion-content"></div>
 `;

 const content = section.querySelector(".accordion-content");

 const allAnswers = [...new Set(
   rawData.flatMap(d=>splitAnswer(
     sectionId==="respon" ? d["respon"] :
     sectionId==="eskalasi" ? d["eskalasi"] :
     d["follow up respon"]
   ))
 )];

 let options = [];

 if(sectionId==="eskalasi"){
   options.push("Tidak diperlukan eskalasi");
 }

 const randomPool = shuffle(allAnswers.filter(a=>!correctAnswers.includes(a)));

 options = [...new Set([
   ...options,
   ...correctAnswers,
   ...randomPool
 ])].slice(0,7);

 options.forEach(opt=>{
   const div=document.createElement("div");
   div.className="checkbox-item";
   div.innerHTML=`
    <input type="checkbox" value="${opt}">
    <label>${opt}</label>
   `;
   content.appendChild(div);
 });

 section.querySelector(".accordion-header").onclick = ()=>{

const content = section.querySelector(".accordion-content");

  if(content.style.display !== "block"){
      sectionStartTime[sectionId] = Date.now();
  } else {
      const duration = Math.floor((Date.now() - sectionStartTime[sectionId]) / 1000);
      sectionTimes[sectionId] = duration;
  }
   content.style.display = content.style.display==="block"?"none":"block";
 };
}

/* ===== TIMER ===== */
function startTimer(){
 startTime = Date.now();

 timerInterval = setInterval(()=>{
   const diff = Math.floor((Date.now()-startTime)/1000);
   const m = String(Math.floor(diff/60)).padStart(2,"0");
   const s = String(diff%60).padStart(2,"0");
   const t = document.getElementById("globalTimer");
if(t){
   t.innerText = "‚è± " + m + ":" + s;
}
   if(diff > 300){
     t.classList.add("red");
   }
 },1000);
}
function formatMMSS(totalSec){
  const m = String(Math.floor(totalSec/60)).padStart(2,"0");
  const s = String(totalSec%60).padStart(2,"0");
  return m + ":" + s;
}

/* ===== CLOSE ISSUE ===== */
const oldClose = closeIssue;
closeIssue = function(){

 const i = current;
 if(completedIssues[i]) return;

issueTimers[i].duration =
  Math.floor((Date.now() - issueTimers[i].start)/1000);

issueTimers[i].closed = true;
 

 const timeSpent = Math.floor((Date.now()-startTime)/1000);

 function calculate(sectionId){
   const checked = [...document.querySelectorAll(`#${sectionId} input:checked`)]
     .map(c=>c.value);

   const correct = issueData[i][sectionId];
   const n = checked.filter(a=>correct.includes(a)).length;
   const N = correct.length;
   return (n/N)*100;
 }
/* FINALIZE SECTION TIME IF STILL OPEN */
["respon","eskalasi","follow"].forEach(sec=>{
  if(sectionStartTime[sec]){
    const duration = Math.floor((Date.now() - sectionStartTime[sec]) / 1000);
    sectionTimes[sec] = duration;
  }
});

 const scoreRes = calculate("respon");
 const scoreEsk = calculate("eskalasi");
 const scoreFol = calculate("follow");

 const total = ((scoreRes+scoreEsk+scoreFol)/3).toFixed(2);

issueTimers[i].duration =
  Math.floor((Date.now() - issueTimers[i].start)/1000);

issueTimers[i].closed = true;

const issueStartSec = Math.floor(
  (issueTimers[i].start - simulationStart) / 1000
);

const issueEndSec = issueStartSec + issueTimers[i].duration;

scores.push({
  issue: issues[i].type,
  totalScore: total,
  windowStart: formatMMSS(issueStartSec),
  windowEnd: formatMMSS(issueEndSec),
  issueDuration: formatMMSS(issueTimers[i].duration)
});


 completedIssues[i]=true;
/* LOCK ALL CHECKBOX AFTER CLOSE */
document.querySelectorAll("#respon input, #eskalasi input, #follow input")
.forEach(cb=>{
  cb.disabled = true;
});

 document.querySelector(".close-btn").classList.add("closed");

 if(Object.keys(completedIssues).length===issues.length){
   showDashboard();
 }

};

/* ===== DASHBOARD ===== */
function showDashboard(){
const finalScore = (
  scores.reduce((a,b)=>
    a + parseFloat(b.totalScore)
  ,0) / scores.length
).toFixed(2);


const resultData = {
  name: participantName,
  npk: participantNPK,
  date: new Date().toLocaleString(),
  finalScore: finalScore,
  detail: scores
};

allResults.push(resultData);
localStorage.setItem("CMT_RESULTS", JSON.stringify(allResults));

 document.getElementById("operational").innerHTML=`
  <div style="padding:40px">
   <h2>Dashboard Hasil Test</h2>
  ${scores.map(s=>`
  <div style="margin:10px 0;padding:10px;border:1px solid #334155;border-radius:12px">
    <b>${s.issue}</b><br><br>

    Response Window: ${s.windowStart} - ${s.windowEnd}<br>
    Durasi Issue: ${s.issueDuration}<br><br>

    <b>Total Score Issue: ${s.totalScore}</b>
  </div>
`).join("")}

  </div>
 `;
}
function showAdminDashboard(){

  document.getElementById("login").classList.add("hidden");
document.body.innerHTML = `
<div style="padding:40px">
<h2>ADMIN REKAP HASIL TEST</h2>

<button onclick="exportExcel()">Export Excel</button>
<button onclick="clearData()">Reset Data</button>

<br><br>

<table border="1" cellpadding="8" style="border-collapse:collapse">
<tr>
<th>Nama</th>
<th>NPK</th>
<th>Score Respon</th>
<th>Waktu Respon (detik)</th>
<th>Score Eskalasi</th>
<th>Waktu Eskalasi (detik)</th>
<th>Score Follow</th>
<th>Waktu Follow (detik)</th>
</tr>

${allResults.map(r=>
  r.detail.map(d=>`
    <tr>
      <td>${r.name}</td>
      <td>${r.npk}</td>
      <td>${d.scoreRespon}</td>
      <td>${d.timeRespon}</td>
      <td>${d.scoreEskalasi}</td>
      <td>${d.timeEskalasi}</td>
      <td>${d.scoreFollow}</td>
      <td>${d.timeFollow}</td>
    </tr>
  `).join("")
).join("")}

</table>
</div>
`;
}
function exportExcel(){

  let exportData = [];

  allResults.forEach(r => {

    let row = {
      Nama: r.name,
      NPK: r.npk
    };

    r.detail.forEach((d, index) => {

      const no = index + 1;

      row[`Type_Issue${no}`] = d.issue;
      row[`Total_Score_Issue${no}`] = d.totalScore;
      row[`Respond_Issue${no}`] = `${d.windowStart}-${d.windowEnd}`;
      row[`Durasi_Issue${no}`] = d.issueDuration;

    });

    exportData.push(row);

  });

  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "CMT Results");

  XLSX.writeFile(wb, "CMT_Results.xlsx");
}

/* ===============================
   ADD-ON GLOBAL TIMER
================================ */

const originalStart = start;

start = function(){

  simulationStart = Date.now();

  globalInterval = setInterval(()=>{
    const diff = Math.floor((Date.now()-simulationStart)/1000);

    const m = String(Math.floor(diff/60)).padStart(2,"0");
    const s = String(diff%60).padStart(2,"0");

    const el = document.getElementById("globalTimer");
    if(el){
      el.innerText = "‚è± " + m + ":" + s;
    }

  },1000);

  originalStart();
};

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</body>
</html>
